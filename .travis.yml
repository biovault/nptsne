branches:
    only:
     - /feature\/.*/
     - release/1.0.0
     - master
     
linux: &linux
    os: linux
    language: python
    sudo: required
    dist: xenial

osx: &osx 
    os: osx
    language: generic
env:
   global:  
     - CONAN_LOGIN_USERNAME="admin"
     - CONAN_PASSWORD=$CONAN_PASSWORD_SECRET  
     - CONAN_UPLOAD="http://cytosplore.lumc.nl:8081/artifactory/api/conan/conan-local"
     - CONAN_STABLE_BRANCH_PATTERN="release/*"
     - CONAN_UPLOAD_ONLY_WHEN_STABLE=1"
     - CIBW_BEFORE_BUILD="pip install scikit-build"

ignore:
    - README.md
    - appveyor.yml  

matrix:
   include:
     - <<: *linux
       python: "3.6" 
       env: 
         - CONAN_GCC_VERSIONS=5 
         - CONAN_DOCKER_IMAGE=conanio/gcc5 
         - CONAN_BUILD_TYPES=Release 
         - CONAN_ARCHS=x86_64
         - CONAN_LINUX_PYTHON=3.6.7
         - CMAKE_GENERATOR="Unix Makefiles"
         - CONAN_OPTIONS="nptsne:python_version=3.6"
         - COMPILER=g++-5
         - CC=gcc-5
         - CXX=g++-5
         - LIBCXX=libstdc++
         - CIBW_BUILD=cp36-manylinux_x86_64
         
     - <<: *linux
       python: "3.7"        
       env:       
         - CONAN_GCC_VERSIONS=5 
         - CONAN_DOCKER_IMAGE=conanio/gcc5
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64 
         - CONAN_LINUX_PYTHON=3.7.1    
         - CMAKE_GENERATOR="Unix Makefiles"
         - CONAN_OPTIONS="nptsne:python_version=3.7:  
         - COMPILER=g++-5
         - CC=gcc-5
         - CXX=g++-5         
         - LIBCXX=libstdc++ 
         - CIBW_BUILD=cp37-manylinux_x86_64
         
     - <<: *osx
       language: generic
       osx_image: xcode10.3
       python: "3.6" 
       env: 
         - CONAN_APPLE_CLANG_VERSIONS=10.0
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64
         - CONAN_IS_TRAVIS_OSX=1 
         - OSX_PYTHON=3.6
         - CMAKE_GENERATOR="Xcode" 
         - CONAN_OPTIONS="nptsne:python_version=3.6"     
         - CIBW_BUILD=cp36-macosx_x86_64         
          
     - <<: *osx
       language: generic
       osx_image: xcode10.3
       python: "3.7" 
       env: 
         - CONAN_APPLE_CLANG_VERSIONS=10.0
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64
         - CONAN_IS_TRAVIS_OSX=1 
         - OSX_PYTHON=3.7
         - CMAKE_GENERATOR="Xcode"
         - CONAN_OPTIONS="nptsne:python_version=3.7"
         - CIBW_BUILD=cp37-macosx_x86_64         

before_install:
  - | 
    if [ "${TRAVIS_OS_NAME:-}" == "osx" ]; then
      brew update
      brew cleanup
    fi
  - if [ "${TRAVIS_OS_NAME:-}" -ne "osx" ]; then
      sudo apt install libpython3.6-dev;
    fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get install -y libglfw3 libglfw3-dev; fi
  - | 
    if [ "$TRAVIS_OS_NAME" = "osx" ]; then
      HOMEBREW_NO_AUTO_UPDATE=1 brew install glfw
    fi
  - python --version 
install:
  - chmod +x .ci/install.sh
  - ./.ci/install.sh
  
  - python --version
  - pip3 show conan
  - pip3 show conan_package_tools
  - pip3 show bincrafters_package_tools
  - conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan
  - pip3 install cmake 


before_script:
   - mkdir _build
   - cd _build

script:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then export SDKROOT=$(xcodebuild -version -sdk macosx Path); fi    
  - cmake .. -G "${CMAKE_GENERATOR}" -DCMAKE_BUILD_TYPE=Release -DNPTSNE_BUILD_WITH_CONAN=ON -DLIBCXX=${LIBCXX}
  # This is a hack to remove an Ã¼nsupported platform darwin" error with distro when building wheel
  - | 
    if [ "$TRAVIS_OS_NAME" = "osx" ]; then
        pip3 uninstall -y conan distro
        pip3 install distro>=1.4.0 scikit-build
    fi    
  - cmake --verbose --build . --target bdist_wheel --config Release
  - cmake --build . --target install_nptsne --config Release
  - ctest --verbose -C release

after_success:  
  - cmake --build . --target upload_wheel --config Release 
