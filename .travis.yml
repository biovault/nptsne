os: linux
language: python
python:
  - 3.6
  - 3.7
  - 3.8
  
branches:
    only:
     - /feature\/.*/
     - release/1.0.0
     - master

# No build on these echanges
ignore:
    - README.md
    - appveyor.yml  

stages:
    -name: build
    -name: build

linux: &linux
    os: linux
    dist: xenial
    language: python
    sudo: required

osx: &osx 
    os: osx
    language: generic
env:
   global:  
     - CIBW_TEST_COMMAND="'python {project}/test/run_doctest.py'"
     - CIBW_SKIP=pp*
     - CONAN_LOGIN_USERNAME="admin"
     - CONAN_PASSWORD=$CONAN_PASSWORD_SECRET  
     - CONAN_UPLOAD="http://cytosplore.lumc.nl:8081/artifactory/api/conan/conan-local"
     - CONAN_STABLE_BRANCH_PATTERN="release/*"
     - CONAN_UPLOAD_ONLY_WHEN_STABLE=1"

before_install:
  - | 
    if [ "${TRAVIS_OS_NAME:-}" == "osx" ]; then
      brew outdated python || brew upgrade python;
    fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get install -y libglfw3 libglfw3-dev; fi
  - | 
    if [ "$TRAVIS_OS_NAME" = "osx" ]; then
      HOMEBREW_NO_AUTO_UPDATE=1 brew install glfw
    fi
  - python3 --version 

  - chmod +x .ci/install.sh
  - ./.ci/install.sh
  - pip3 show conan
  - pip3 show conan_package_tools
  - pip3 show bincrafters_package_tools
  - conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan

script: python3 -m cibuildwheel --output-dir wheelhouse

after_success:  
  - cmake --build . --target upload_wheel --config Release 

jobs:
   include:

     - stage: build
       name: Build Linux wheels
       <<: *linux
       python: "3.7"
       services: docker
       install: python3 -m pip install cibuildwheel==1.3.0
       script: python3 -m cibuildwheel --output-dir wheelhouse
       env:
         - CONAN_GCC_VERSIONS=5 
         - CONAN_DOCKER_IMAGE=conanio/gcc5
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64 
         - CONAN_LINUX_PYTHON=3.7.1
         - CMAKE_GENERATOR="Unix Makefiles"
         - CONAN_OPTIONS="nptsne:python_version=3.7"
         - COMPILER=g++-5
         - CC=gcc-5
         - CXX=g++-5
         - LIBCXX=libstdc++ 
         - CIBW_SKIP="cp2* cp35-* pp*"
         - CIBW_BUILD=cp37-manylinux_x86_64
         - CIBW_BUILD_VERBOSITY=3
         - CIBW_BEFORE_BUILD="pip3 install cmake conan && conan user && conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan"
         
     - stage: build
       name: Build macOS wheels without OpenMP
       <<: *osx
       language: generic
       osx_image: xcode9.4
       python: "3.7"
       script: python3 -m cibuildwheel --output-dir wheelhouse
       env: 
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64
         - CONAN_IS_TRAVIS_OSX=1 
         - OSX_PYTHON=3.7
         - CMAKE_GENERATOR="Xcode"
         - CONAN_OPTIONS="nptsne:python_version=3.7"
         - CIBW_BEFORE_BUILD_MACOS="'export SDKROOT=$(xcodebuild -version -sdk macosx Path)'"
         - CIBW_BUILD=cp37-macosx_x86_64
         - HOMEBREW_NO_AUTO_UPDATE=1


     - stage: build
       name: Build macOS wheels with OpenMP
       <<: *osx
       language: generic
       osx_image: xcode10.3
       python: "3.7"
       script: python3 -m cibuildwheel --output-dir wheelhouse
       env: 
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64
         - CONAN_IS_TRAVIS_OSX=1 
         - OSX_PYTHON=3.7
         - CMAKE_GENERATOR="Xcode"
         - CONAN_OPTIONS="nptsne:python_version=3.7"
         - CIBW_BEFORE_BUILD_MACOS="'export SDKROOT=$(xcodebuild -version -sdk macosx Path)'"
         - CIBW_BUILD=cp37-macosx_x86_64
         - HOMEBREW_NO_AUTO_UPDATE=1
