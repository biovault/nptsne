branches:
    only:
     - /feature\/.*/
     - release/1.0.0
     - master
     
linux: &linux
    os: linux
    language: python
    sudo: required
    dist: xenial

osx: &osx 
    os: osx
    language: generic
env:
   global:  
     - CONAN_LOGIN_USERNAME="admin"
     - CONAN_PASSWORD=$CONAN_PASSWORD_SECRET  
     - CONAN_UPLOAD="http://cytosplore.lumc.nl:8081/artifactory/api/conan/conan-local"
     - CONAN_STABLE_BRANCH_PATTERN="release/*"
     - CONAN_UPLOAD_ONLY_WHEN_STABLE=1"

ignore:
    - README.md
    - appveyor.yml  

matrix:
   include:
     - <<: *linux
       python: "3.6" 
       env: 
         - CONAN_GCC_VERSIONS=5 
         - CONAN_DOCKER_IMAGE=conanio/gcc5 
         - CONAN_BUILD_TYPES=Release 
         - CONAN_ARCHS=x86_64
         - CONAN_LINUX_PYTHON=3.6.7
         - CMAKE_GENERATOR="Unix Makefiles"
         - CONAN_OPTIONS="nptsne:python_version=3.6"
         - COMPILER=g++-5
         - CC=gcc-5
         - CXX=g++-5
         - LIBCXX=libstdc++
     - <<: *linux
       python: "3.7"        
       env:       
         - CONAN_GCC_VERSIONS=5 
         - CONAN_DOCKER_IMAGE=conanio/gcc5
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64 
         - CONAN_LINUX_PYTHON=3.7.1    
         - CMAKE_GENERATOR="Unix Makefiles"
         - CONAN_OPTIONS="nptsne:python_version=3.7:  
         - COMPILER=g++-5
         - CC=gcc-5
         - CXX=g++-5         
         - LIBCXX=libstdc++   
     - <<: *osx
       language: generic
       osx_image: xcode10.3
       python: "3.6" 
       env: 
         - CONAN_APPLE_CLANG_VERSIONS=10.0
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64
         - CONAN_IS_TRAVIS_OSX=1 
         - OSX_PYTHON=3.6
         - CMAKE_GENERATOR="Xcode" 
         - CONAN_OPTIONS="nptsne:python_version=3.6"               
          
     - <<: *osx
       language: generic
       osx_image: xcode10.3
       python: "3.7" 
       env: 
         - CONAN_APPLE_CLANG_VERSIONS=10.0
         - CONAN_BUILD_TYPES=Release
         - CONAN_ARCHS=x86_64
         - CONAN_IS_TRAVIS_OSX=1 
         - OSX_PYTHON=3.7
         - CMAKE_GENERATOR="Xcode"
         - CONAN_OPTIONS="nptsne:python_version=3.7"                

before_install:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get install -y libglfw3 libglfw3-dev; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then 
        brew update
        brew install python3
    fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then    
        pip install --user --upgrade pip virtualenv
        virtualenv -p python$OSX_PYTHON build_env
        source build_env/bin/activate
    fi  
install:
  - chmod +x .ci/install.sh
  - ./.ci/install.sh
  
  - python --version
  - pip show conan
  - pip show conan_package_tools
  - pip show bincrafters_package_tools
  - conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan
  - pip install cmake

before_script:
   - mkdir _build
   - cd _build

script:
  - cmake .. -G "${CMAKE_GENERATOR}" -DCMAKE_BUILD_TYPE=Release -DNPTSNE_BUILD_WITH_CONAN=ON -DLIBCXX=${LIBCXX}
  - cmake --build . --config Release
  - cmake --build . --target bdist_wheel --config Release  # Need sudo because this calls install
